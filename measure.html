<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>O'lchash — Avtomatik (millimetr)</title>

    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --muted: #94a3b8;
        --line: #1f2937;
        --accent: #06b6d4;
        --ok: #10b981;
        --text: #e5e7eb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial,
          sans-serif;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px;
      }
      header.site {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #0b1220;
        padding: 14px 20px;
        border-bottom: 1px solid var(--line);
      }
      .brand {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .logo {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        background: linear-gradient(135deg, #0284c7, #06b6d4);
      }
      h1 {
        font-size: 1rem;
        margin: 0;
      }
      nav ul {
        display: flex;
        gap: 12px;
        list-style: none;
        margin: 0;
        padding: 0;
      }
      nav a {
        color: #cbd5e1;
        text-decoration: none;
        padding: 8px 10px;
        border-radius: 8px;
      }
      nav a.cta {
        background: var(--accent);
        color: #001018;
        font-weight: 600;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      @media (min-width: 960px) {
        .grid-2 {
          grid-template-columns: 360px 1fr;
        }
      }
      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 16px;
      }
      .muted {
        color: var(--muted);
        font-size: 0.92rem;
      }
      input[type='file'] {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #233041;
        background: #0b1220;
        color: var(--text);
      }
      .btn {
        background: var(--accent);
        color: #052129;
        border: none;
        padding: 10px 14px;
        border-radius: 12px;
        margin-top: 10px;
        cursor: pointer;
      }
      .btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin: 8px 0;
      }
      .row input,
      .row select {
        background: #0b1220;
        border: 1px solid #223;
        color: #e5e7eb;
        border-radius: 8px;
        padding: 8px 10px;
      }
      .preview {
        background: #0b1220;
        border: 1px dashed #334155;
        border-radius: 12px;
        min-height: 520px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      canvas {
        max-width: 100%;
        height: auto;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
        margin-top: 0.5rem;
      }
      th,
      td {
        text-align: left;
        padding: 10px 12px;
      }
      th {
        background: #0b1220;
        color: #cbd5e1;
        border: 1px solid #223;
      }
      td {
        background: #0b1220;
        border: 1px solid #223;
      }
      .value {
        color: var(--accent);
        font-variant-numeric: tabular-nums;
      }
      .alert {
        margin-top: 0.6rem;
        padding: 10px 12px;
        border-radius: 10px;
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(239, 68, 68, 0.45);
        color: #fecaca;
        font-size: 0.92rem;
        display: none;
      }
      .ok {
        background: rgba(16, 185, 129, 0.08);
        border-color: rgba(16, 185, 129, 0.4);
        color: #bbf7d0;
      }
      footer {
        color: #8fa3b8;
        text-align: center;
        padding: 24px 0;
      }
      .hint {
        font-size: 0.85rem;
        color: #93a3b8;
      }
    </style>
  </head>

  <body>
    <header class="site">
      <div class="brand">
        <div class="logo"></div>
        <h1>O‘lchash (millimetr)</h1>
      </div>
      <nav>
        <ul>
          <li><a href="index.html#how">Qanday ishlaydi</a></li>
          <li><a href="index.html#meals">Kategoriyalar</a></li>
          <li><a href="index.html#cta">Aloqa</a></li>
          <li><a class="cta" href="index.html">Bosh sahifa</a></li>
        </ul>
      </nav>
    </header>

    <main class="container">
      <p class="muted">
        Backend orqali ishlaydi — natijalar <b>millimetr</b>larda (haqiqiy
        o‘lcham).
      </p>

      <div class="grid grid-2">
        <section class="card">
          <h2>1) Rasm yuklash</h2>

          <!-- Scaling choices -->
          <div class="row">
            <span class="hint">Kalibratsiya:</span>
            <select id="refSelect" title="Ma’lumotnoma obyekt (ixtiyoriy)">
              <option value="">— Obyekt yo‘q —</option>
              <option value="a4">A4 qog‘oz (297×210 mm)</option>
              <option value="card">Karta / ID (85.6×53.98 mm)</option>
            </select>
            <span class="hint">yoki</span>
            <label for="heightInput" class="hint">Bo‘yingiz (mm):</label>
            <input
              id="heightInput"
              type="number"
              inputmode="numeric"
              placeholder="masalan 1780"
              style="width: 120px"
            />
          </div>
          <p class="hint">
            * Uchtadan biri kifoya: haqiqiy bo‘yingizni kiriting
            <b>yoki</b> kadrlarda A4/karta ko‘rinsin.
          </p>

          <input
            id="file"
            type="file"
            accept="image/jpeg,image/jpg,image/png,image/*"
          />

          <table>
            <thead>
              <tr>
                <th>Ko‘rsatkich</th>
                <th>Qiymat (mm)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Bo‘yi</td>
                <td id="m_height" class="value">—</td>
              </tr>
              <tr>
                <td>Qo‘l uzunligi (o‘rta)</td>
                <td id="m_arm" class="value">—</td>
              </tr>
              <tr>
                <td>Oyoq uzunligi (o‘rta)</td>
                <td id="m_leg" class="value">—</td>
              </tr>
              <tr>
                <td>Ko‘krak kengligi</td>
                <td id="m_chest_w" class="value">—</td>
              </tr>
              <tr>
                <td>Bel kengligi (taxminiy)</td>
                <td id="m_waist_w" class="value">—</td>
              </tr>
              <tr>
                <td>Bo‘ksa kengligi</td>
                <td id="m_hip_w" class="value">—</td>
              </tr>
            </tbody>
          </table>

          <button id="btnCsv" class="btn" disabled>CSV yuklab olish</button>
          <div id="msg" class="alert"></div>
        </section>

        <section class="card">
          <h2>2) Oldindan ko‘rish</h2>
          <div class="preview"><canvas id="canvas"></canvas></div>
        </section>
      </div>
    </main>

    <footer>© <span id="y"></span> — O‘lchash prototipi (mm)</footer>

    <script>
      // ===== Config
      const API_BASE = 'http://localhost:8000'; // change for deploy

      // ===== DOM
      const $ = (s) => document.querySelector(s);
      const msgEl = $('#msg');
      $('#y').textContent = new Date().getFullYear();
      const canvas = $('#canvas');
      const ctx = canvas.getContext('2d');

      const setVal = (id, v) =>
        ($('#' + id).textContent =
          typeof v === 'number' && Number.isFinite(v) ? v.toFixed(1) : '—');
      const clearVals = () =>
        [
          'm_height',
          'm_arm',
          'm_leg',
          'm_chest_w',
          'm_waist_w',
          'm_hip_w',
        ].forEach((k) => setVal(k, NaN));
      const showMsg = (t, ok = false) => {
        msgEl.textContent = t;
        msgEl.style.display = 'block';
        msgEl.classList.toggle('ok', ok);
      };
      const hideMsg = () => {
        msgEl.style.display = 'none';
        msgEl.classList.remove('ok');
      };

      function drawImageFit(img) {
        const scale = Math.min(900 / img.width, 1);
        canvas.width = Math.max(1, Math.floor(img.width * scale));
        canvas.height = Math.max(1, Math.floor(img.height * scale));
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }

      function downloadCSV(csvText) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([csvText], { type: 'text/csv' }));
        a.download = 'measurements_mm.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      // ===== Upload flow
      let lastCSV = null;

      $('#file').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;

        // Reset
        hideMsg();
        clearVals();
        $('#btnCsv').disabled = true;
        lastCSV = null;

        // Preview
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => {
          drawImageFit(img);
          URL.revokeObjectURL(url);
        };
        img.src = url;

        // Build query
        const ref = $('#refSelect').value.trim();
        const h = $('#heightInput').value.trim();
        let q = new URLSearchParams({ return_csv: 'true' });
        if (h) q.set('person_height_mm', h);
        else if (ref) q.set('ref', ref);

        // If user provided neither, warn early (backend would 422 anyway)
        if (!h && !ref)
          showMsg(
            'Kalibratsiya ma’lumoti kiriting: bo‘yingiz yoki A4/karta tanlang.',
            false
          );

        try {
          showMsg('Hisoblanmoqda...', false);
          const fd = new FormData();
          fd.append('image', f);

          const res = await fetch(`${API_BASE}/api/measure?` + q.toString(), {
            method: 'POST',
            body: fd,
          });

          if (!res.ok) {
            // Try to read server error
            let msg = 'Xatolik yuz berdi.';
            try {
              const j = await res.json();
              msg = j.error || msg;
            } catch {}
            if (res.status === 422 && !h && !ref)
              msg =
                'Kalibratsiya topilmadi. Bo‘yingizni kiriting yoki ref obyektni tanlang.';
            showMsg(msg);
            return;
          }

          const data = await res.json();
          if (!data.ok) {
            showMsg(data.error || 'Xatolik.');
            return;
          }

          const m = data.metrics || {};
          setVal('m_height', m.height_mm);
          setVal('m_arm', m.arm_length_mm);
          setVal('m_leg', m.leg_length_mm);
          setVal('m_chest_w', m.chest_width_mm);
          setVal('m_waist_w', m.waist_width_mm);
          setVal('m_hip_w', m.hip_width_mm);

          if (data.csv) {
            lastCSV = data.csv;
            $('#btnCsv').disabled = false;
          }

          const scale = data.scale_mm_per_px
            ? ` (mm/px: ${(+data.scale_mm_per_px).toFixed(3)})`
            : '';
          showMsg('O‘lchovlar tayyor.' + scale, true);
        } catch (err) {
          console.error(err);
          showMsg('Tarmoq xatoligi yoki server ishlamayapti.');
        }
      });

      // CSV button
      $('#btnCsv').addEventListener('click', () => {
        if (lastCSV) downloadCSV(lastCSV);
      });
    </script>
  </body>
</html>
